name: Publish to PyPI

on:
  release:
    types: [published]

jobs:
  bump-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-bump versions to match release tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "Bumping all versions to: $VERSION"

          # Update pyproject.toml
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" pyproject.toml

          # Update plugin.json
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" plugins/sage/.claude-plugin/plugin.json

          # Update marketplace.json
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" .claude-plugin/marketplace.json

          # Show what changed
          echo "=== Updated versions ==="
          grep "^version" pyproject.toml
          grep "version" plugins/sage/.claude-plugin/plugin.json
          grep "version" .claude-plugin/marketplace.json

      - name: Commit version bump
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add -A
          git diff --staged --quiet || git commit -m "(chore): auto-bump version to ${GITHUB_REF_NAME#v}"
          git push

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build tools
        run: pip install build

      - name: Build package
        run: python -m build

      - uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  publish:
    needs: bump-and-build
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/
      - uses: pypa/gh-action-pypi-publish@release/v1
